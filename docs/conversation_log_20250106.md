# HF Parser 项目对话记录

**日期**: 2025-01-06
**项目**: 私募基金周报数据解析与入库

---

## 1. 项目背景

用户需要解析私募基金周报数据（PDF和Excel格式），并将数据导入MySQL数据库。每周会有一个PDF文件和可能的Excel文件，包含全市场各类私募基金产品的业绩表现。

### 数据来源
- 3周的数据文件：1205、1212、1219
- Excel文件数据更准确
- PDF文件数据更完整
- 当两者都存在时：Excel优先，PDF补充

---

## 2. 需求访谈记录

### 2.1 数据结构需求

| 问题 | 用户选择 |
|------|---------|
| 唯一标识符 | 产品代码 |
| 产品代码来源 | 从1205 Excel通过产品名称匹配获取 |
| 公司信息存储 | 单独建立Manager表 |
| 策略分类层级 | 三级分类（level1/level2/level3分开存储） |
| 策略分类标准 | 仅使用1219的22个Sheet名称作为level3 |

### 2.2 数据处理策略

| 问题 | 用户选择 |
|------|---------|
| 数据优先级 | Excel优先，PDF补充 |
| 未识别策略 | 归入"未分类" |
| 缺失产品代码 | 使用产品名称+管理人生成临时代码（TMP_前缀） |
| 导入范围 | 仅导入1219数据（策略分类和业绩数据） |

---

## 3. 数据库设计

### 3.1 表结构

```
managers          - 管理人维度表
strategies        - 策略分类维度表（三级分类）
funds             - 产品主表
fund_performance  - 业绩时间序列表
report_metadata   - 报告元数据表
```

### 3.2 策略三级分类（22个）

| Level3 (Sheet名) | Level2 | Level1 |
|-----------------|--------|--------|
| 指增300 | 指数增强 | 股票策略 |
| 指增500 | 指数增强 | 股票策略 |
| 指增1000 | 指数增强 | 股票策略 |
| 其他指增 | 指数增强 | 股票策略 |
| 量化选股 | 量化选股 | 股票策略 |
| 主观股票 | 主观股票 | 股票策略 |
| 中性策略 | 中性策略 | 股票策略 |
| 量化商品 | 量化CTA | 商品策略 |
| 主观商品 | 主观CTA | 商品策略 |
| 量化商品套利 | 商品套利 | 套利策略 |
| 主观商品套利 | 商品套利 | 套利策略 |
| 期权套利 | 期权套利 | 套利策略 |
| ETF套利 | ETF套利 | 套利策略 |
| 股指套利 | 股指套利 | 套利策略 |
| 多策略套利 | 多策略套利 | 套利策略 |
| 固收 | 纯债 | 固收策略 |
| 固收+ | 固收增强 | 固收策略 |
| 债券复合 | 债券复合 | 固收策略 |
| 转债策略 | 转债 | 固收策略 |
| 宏观策略 | 宏观策略 | 宏观策略 |
| 多策略 | 多策略 | 多策略 |
| FOF | FOF | 多策略 |

---

## 4. 技术实现

### 4.1 关键发现

1. **1219 Excel没有产品代码列**
   - 只有1205 Excel有产品代码
   - 解决方案：从1205建立"产品名称->产品代码"映射表

2. **两种列命名格式**
   - 指数增强类：使用"超额"（excess）列
   - 其他策略类：使用"收益率"（return）列
   - 解决方案：COLUMN_MAP同时支持两种格式

3. **产品代码匹配率**
   - 从1205匹配到5491个产品代码
   - 1219中4403个产品，匹配成功4301个（97.7%）
   - 102个产品生成临时代码

### 4.2 核心代码文件

- `src/database/models.py` - SQLAlchemy ORM模型
- `import_1219.py` - 1219数据导入脚本

### 4.3 关键函数

```python
# 百分比转小数（带NaN处理）
def percent_to_decimal(value) -> Optional[Decimal]:
    if pd.isna(value):
        return None
    if isinstance(value, (int, float)):
        import math
        if math.isnan(value):
            return None
        # 转换逻辑...

# 生成临时产品代码
def generate_temp_code(fund_name: str, manager_name: str) -> str:
    key = f"{fund_name}_{manager_name}"
    hash_val = hashlib.md5(key.encode()).hexdigest()[:8].upper()
    return f"TMP_{hash_val}"
```

---

## 5. 问题修复记录

### 5.1 导入路径错误
**错误**: `ImportError: attempted relative import beyond top-level package`
**修复**: 同时添加src_path和parent path到sys.path

### 5.2 数据库表结构不匹配
**错误**: `Unknown column 'strategies.level3_category'`
**修复**: 删除所有表并使用新schema重建

### 5.3 SQL中的NaN值
**错误**: `Unknown column 'NaN' in 'field list'`
**修复**: 在percent_to_decimal和ratio字段解析中添加math.isnan()检查

### 5.4 数据完整性低（9.4%）
**原因**: COLUMN_MAP只有"超额"列，缺少"收益率"列
**修复**: 添加所有"收益率"列的映射

### 5.5 业绩字段未保存
**原因**: FundPerformance构造函数缺少return字段
**修复**: 添加weekly_return、monthly_return、quarterly_return等字段

---

## 6. 最终结果

### 6.1 导入统计

| 数据类型 | 数量 |
|---------|------|
| 管理人 | 1,434 |
| 策略 | 23 |
| 基金产品 | 4,076 |
| 业绩记录 | 4,076 |

### 6.2 数据完整性验证

```
总记录: 4076
有周收益: 4076 (100.0%)
有年化收益: 4076 (100.0%)
有累计收益: 4076 (100.0%)
```

### 6.3 各策略数据量

| 策略 | 产品数 |
|------|-------|
| 指增300 | 289 |
| 指增500 | 405 |
| 指增1000 | 456 |
| 其他指增 | 161 |
| 量化选股 | 295 |
| 主观股票 | 217 |
| 中性策略 | 492 |
| 量化商品 | 488 |
| 主观商品 | 134 |
| 量化商品套利 | 61 |
| 主观商品套利 | 12 |
| 期权套利 | 50 |
| ETF套利 | 24 |
| 股指套利 | 41 |
| 多策略套利 | 78 |
| 固收 | 176 |
| 固收+ | 144 |
| 债券复合 | 120 |
| 转债策略 | 117 |
| 宏观策略 | 67 |
| 多策略 | 152 |
| FOF | 97 |

---

## 7. 后续扩展建议

1. **增量更新**: 设计支持每周数据增量导入
2. **PDF解析**: 当只有PDF文件时的解析方案
3. **数据验证**: 跨周数据一致性检查
4. **历史快照**: 保留每周业绩快照便于趋势分析

---

*文档生成时间: 2025-01-06*
